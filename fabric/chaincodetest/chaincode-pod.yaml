apiVersion: v1
kind: ConfigMap
metadata:
  name: chaincode-source
  namespace: fabric
data:
  package.json: |
    {
      "name": "basic-asset-transfer",
      "version": "1.0.0",
      "description": "No-Build Chaincode",
      "main": "index.js",
      "engines": {
        "node": ">=12",
        "npm": ">=5"
      },
      "scripts": {
        "start": "fabric-chaincode-node server --chaincode-address=$CHAINCODE_ADDRESS --chaincode-id=$CHAINCODE_CCID"
      },
      "dependencies": {
        "fabric-contract-api": "^2.4.0",
        "fabric-shim": "^2.4.0"
      }
    }
  index.js: |
    'use strict';
    const { Contract } = require('fabric-contract-api');

    class AssetTransfer extends Contract {
        async CreateAsset(ctx, id, color, owner) {
            const asset = {
                ID: id,
                Color: color,
                Owner: owner,
            };
            await ctx.stub.putState(id, Buffer.from(JSON.stringify(asset)));
            return JSON.stringify(asset);
        }

        async ReadAsset(ctx, id) {
            const assetJSON = await ctx.stub.getState(id);
            if (!assetJSON || assetJSON.length === 0) {
                throw new Error(`Asset ${id} does not exist`);
            }
            return assetJSON.toString();
        }
    }
    module.exports.AssetTransfer = AssetTransfer;
    module.exports.contracts = [AssetTransfer];

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chaincode-asset
  namespace: fabric
spec:
  replicas: 1
  selector:
    matchLabels:
      app: chaincode-asset
  template:
    metadata:
      labels:
        app: chaincode-asset
    spec:
      containers:
        - name: chaincode
          image: node:18-alpine
          workingDir: /usr/src/app
          # Dosyaları kopyala -> Paketleri kur -> Başlat
          command: ["/bin/sh", "-c"]
          args: 
            - cp /tmp/code/* /usr/src/app/ && npm install && npm start
          env:
            # --- BURAYA GÜNCEL PACKAGE ID GELECEK ---
            - name: CHAINCODE_CCID
              value: "basic_1.0:d6783996ca25ad54cfb6b9d7b1c017bd31c37aed7933b4b3aae96d859781675e"
            # ----------------------------------------
            - name: CHAINCODE_ADDRESS
              value: "0.0.0.0:9999"
          ports:
            - containerPort: 9999
          volumeMounts:
            - name: code-volume
              mountPath: /tmp/code
      volumes:
        - name: code-volume
          configMap:
            name: chaincode-source
---
apiVersion: v1
kind: Service
metadata:
  name: chaincode-asset
  namespace: fabric
spec:
  type: ClusterIP
  ports:
    - port: 9999
      targetPort: 9999
  selector:
    app: chaincode-asset
